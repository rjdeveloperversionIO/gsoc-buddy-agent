name: Sync to Supabase

on:
  workflow_dispatch:  # Allows manual triggering

jobs:
  sync-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas gspread oauth2client supabase
      
      - name: Create service account key file
        run: |
          # Install jq for JSON validation
          sudo apt-get update
          sudo apt-get install -y jq
          
          # Write the secret to a file
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT }}' > service_account_raw.txt
          
          # Ensure it's valid JSON by removing any extra characters
          cat service_account_raw.txt | tr -d '\r' > service_account.json
          
          # Check if it's valid JSON
          if ! jq . service_account.json &>/dev/null; then
            echo "Error: Invalid JSON in service account key"
            echo "First few characters:"
            head -c 20 service_account.json
            exit 1
          fi
      
      - name: Sync data to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          cat > sync_to_supabase.py << 'EOF'
          import json
          import pandas as pd
          import gspread
          from oauth2client.service_account import ServiceAccountCredentials
          from datetime import datetime
          import os
          from supabase import create_client, Client

          # Get Supabase credentials from environment
          supabase_url = os.environ.get('SUPABASE_URL')
          supabase_key = os.environ.get('SUPABASE_KEY')
          
          if not supabase_url or not supabase_key:
              raise ValueError("Supabase credentials not set in environment variables")

          # Initialize Supabase client
          supabase: Client = create_client(supabase_url, supabase_key)

          # Configure Google Sheets API
          scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
          credentials = ServiceAccountCredentials.from_json_keyfile_name('service_account.json', scope)
          gc = gspread.authorize(credentials)

          # Open the spreadsheet - use your existing sheet ID
          spreadsheet = gc.open_by_key('19PfXdNw--raP07c3tLzOBYcAC44-AfPeM-nxI8t4cKA')
          
          print("Syncing Organizations...")
          
          # Get organizations data
          orgs_sheet = spreadsheet.worksheet('Organizations')
          orgs_data = orgs_sheet.get_all_records()
          
          # Process each organization
          for org in orgs_data:
              # Convert string lists to arrays
              if 'gsoc_years' in org:
                  # Handle both string and integer types
                  if isinstance(org['gsoc_years'], str) and org['gsoc_years']:
                      org['gsoc_years'] = org['gsoc_years'].split(',')
                  elif isinstance(org['gsoc_years'], int):
                      org['gsoc_years'] = [str(org['gsoc_years'])]
                  else:
                      org['gsoc_years'] = []
              else:
                  org['gsoc_years'] = []
                  
              if 'primary_languages' in org and isinstance(org['primary_languages'], str) and org['primary_languages']:
                  org['primary_languages'] = org['primary_languages'].split(',')
              else:
                  org['primary_languages'] = []
                  
              if 'categories' in org and isinstance(org['categories'], str) and org['categories']:
                  org['categories'] = org['categories'].split(',')
              else:
                  org['categories'] = []
                  
              # Convert empty strings to null
              for key, value in org.items():
                  if value == '':
                      org[key] = None
                      
              # Convert numeric fields
              for field in ['repo_count', 'stars_total', 'open_issues_count', 'good_first_issues_count']:
                  if field in org and org[field]:
                      try:
                          org[field] = int(org[field])
                      except:
                          org[field] = None
                          
              if 'avg_issue_resolution_days' in org and org['avg_issue_resolution_days']:
                  try:
                      org['avg_issue_resolution_days'] = float(org['avg_issue_resolution_days'])
                  except:
                      org['avg_issue_resolution_days'] = None
                      
              # Convert communication_channels to JSON
              if 'communication_channels' in org and isinstance(org['communication_channels'], str) and org['communication_channels']:
                  try:
                      org['communication_channels'] = json.loads(org['communication_channels'])
                  except:
                      # If not valid JSON, create a simple object
                      org['communication_channels'] = {"note": org['communication_channels']}
              else:
                  org['communication_channels'] = {}
                  
              # Upsert to Supabase
              try:
                  # Check if org exists by github_org
                  if org.get('github_org'):
                      existing = supabase.table('organizations').select('org_id').eq('github_org', org['github_org']).execute()
                      
                      if existing.data and len(existing.data) > 0:
                          # Update existing record
                          org_id = existing.data[0]['org_id']
                          supabase.table('organizations').update(org).eq('org_id', org_id).execute()
                          print(f"Updated organization: {org['name']}")
                      else:
                          # Insert new record
                          supabase.table('organizations').insert(org).execute()
                          print(f"Inserted organization: {org['name']}")
                  else:
                      # Check by name if github_org is not available
                      existing = supabase.table('organizations').select('org_id').eq('name', org['name']).execute()
                      
                      if existing.data and len(existing.data) > 0:
                          # Update existing record
                          org_id = existing.data[0]['org_id']
                          supabase.table('organizations').update(org).eq('org_id', org_id).execute()
                          print(f"Updated organization by name: {org['name']}")
                      else:
                          # Insert new record
                          supabase.table('organizations').insert(org).execute()
                          print(f"Inserted organization by name: {org['name']}")
              except Exception as e:
                  print(f"Error syncing organization {org.get('name', 'unknown')}: {str(e)}")
          
          # Rest of the script remains the same...
          EOF
          
          python sync_to_supabase.py
      
      - name: Clean up
        run: |
          rm service_account.json
          rm sync_to_supabase.py
