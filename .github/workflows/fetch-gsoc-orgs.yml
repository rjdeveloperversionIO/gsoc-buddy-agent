name: Fetch GSoC Organizations

on:
  workflow_dispatch:  # Allows manual triggering
  schedule:
    - cron: '0 0 * * 1'  # Run weekly on Monday at midnight

jobs:
  fetch-orgs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Create API script
        run: |
          mkdir -p scripts
          cat > scripts/github-api.sh << 'EOF'
          #!/bin/bash
          
          # Configuration
          API_BASE="https://api.github.com"
          MAX_RETRIES=3
          RETRY_DELAY=5
          
          # Check if GITHUB_TOKEN is set
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "Error: GITHUB_TOKEN environment variable is not set"
            exit 1
          fi
          
          # Parse arguments
          ENDPOINT=$1
          METHOD=${2:-GET}
          DATA=${3:-""}
          
          # Make the API request
          if [ "$METHOD" = "GET" ]; then
            curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_BASE$ENDPOINT"
          else
            curl -s -X "$METHOD" -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Content-Type: application/json" -d "$DATA" \
                  "$API_BASE$ENDPOINT"
          fi
          EOF
          
          chmod +x scripts/github-api.sh
      
      - name: Fetch sample GSoC organizations
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          echo "Fetching sample GSoC organizations..."
          
          # Create data directory if it doesn't exist
          mkdir -p data
          
          # Sample list of known GSoC organizations
          ORGS=("zulip" "tensorflow" "kubernetes" "mozilla" "wikimedia")
          
          # Fetch each organization's data
          for org in "${ORGS[@]}"; do
            echo "Fetching data for $org..."
            ./scripts/github-api.sh "/orgs/$org" > "data/$org-info.json"
            
            # Fetch repositories for this organization
            ./scripts/github-api.sh "/orgs/$org/repos?per_page=5" > "data/$org-repos.json"
            
            # For the first repo, fetch some issues
            FIRST_REPO=$(cat "data/$org-repos.json" | jq -r '.[0].name')
            if [ ! -z "$FIRST_REPO" ]; then
              echo "Fetching issues for $org/$FIRST_REPO..."
              ./scripts/github-api.sh "/repos/$org/$FIRST_REPO/issues?state=open&per_page=5" > "data/$org-$FIRST_REPO-issues.json"
            fi
          done
          
          echo "âœ… Fetched data for ${#ORGS[@]} organizations"
          
          # Display the data
          echo "Organization data:"
          ls -la data/
          cat data/zulip-info.json | jq .
      
      - name: Upload data as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: gsoc-org-data
          path: data/
          retention-days: 7
